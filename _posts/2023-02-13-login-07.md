---
title: 로그인 페이지 만들기 - 07
author: Psmin
data: 2023-02-13 23:07:02 +0900
categories: [Nodejs]
tags: [crypto, passport-local]
---

# Crypto 모듈을 이용해 비밀번호를 암호화해보자.

- 추가로 passport 모듈을 이용해 로그인 인증를 구현해보자.

---

## 비밀번호 암호화

JWT 토큰 방식 적용 전 crypto 모듈을 이용해 비밀번호를 암호화해서 DB에 저장해보겠습니다.

---

### 암호화 및 검증 함수

**_middleware_** 폴더에 `crypto.js` 파일을 만들어 모듈화해 사용하겠습니다.

```js
// middleware/crypto.js
import crypto from "crypto";
import util from "util";

// randomBytes 함수를 Promise로 반환하는 함수로 변환합니다.
const randomBytesPromise = util.promisify(crypto.randomBytes);

// 암호화된 비밀번호 생성 함수
// 암호화된 비밀번호와 임의로 생성된 salt를 '$'를 기준으로 이어줍니다.
const createPasswordAndSalt = async (password) => {
  const buf = await randomBytesPromise(64);
  const salt = buf.toString("base64");

  const key = crypto
    .pbkdf2Sync(password, salt, 104906, 64, "sha512")
    .toString("base64");

  return `${key}$${salt}`;
};

// 비밀번호 검증 함수
// 사용자의 입력 값과 데이터베이스에 저장된 암호화된 값을 비교해 검증합니다.
const userPasswordVerify = async (givenPassword, PasswordAndSalt) => {
  const [encrypted, salt] = PasswordAndSalt.split("$");
  const givenEncrypted = crypto
    .pbkdf2Sync(givenPassword, salt, 104906, 64, "sha512")
    .toString("base64");

  if (givenEncrypted === encrypted) {
    return true;
  } else {
    return false;
  }
};

export { createPasswordAndSalt, userPasswordVerify };
```

---

### Controller 수정

**_Controller_**에서 **_model_**에 요청하기 전 비밀번호를 암호화합니다.

```js
import logger from "../middleware/logger.js";
import { createPasswordAndSalt, userPasswordVerify } from "../middleware/crypto.js";
import UserStorage from "../models/model_user.js";

const output = {
  ...
};

const process = {
  login: async (req, res) => {
    try {
      const { id, password, nickname } = await UserStorage.getUserInfo(req.body.id);

      var response = {};

      if (id) {
        // 사용자가 입력한 비밀번호 req.body.password 와 데이터베이스에 저장된 암호화된 데이터를 인자로 전달합니다.
        if (await userPasswordVerify(req.body.password, password)) {
          req.session.is_logined = true;
          req.session.nickname = nickname;

          response = { success: true };
        } else {
          response = { success: false, msg: "비밀번호가 틀렸습니다." };
        }
      } else {
        response = { success: false, msg: "존재하지 않는 아이디입니다." };
      }

      res.json(response);
    } catch (err) {
      const response = { success: false, msg: "로그인을 할 수 없습니다.\n잠시 후 다시 시도해주세요." };

      res.json(response);
    }
  },

  register: async (req, res) => {
    try {
      // 해당 아이디가 데이터베이스에 이미 존재하는지 확인
      const check = await UserStorage.getUserInfo(req.body.id);

      // 사용자가 입력한 비밀번호를 createPasswordAndSalt 로 암호화합니다.
      req.body.password = await createPasswordAndSalt(req.body.password);

      var response = {};

      if (check) {
        response = { success: false, msg: "아이디가 존재합니다." };
      } else {
        // 데이터베이스에 새로운 사용자 INSERT
        response = await UserStorage.createUser(req.body);
      }

      res.json(response);
    } catch (err) {
      console.log(err);
      const response = { success: false, msg: "회원가입을 할 수 없습니다.\n 잠시 후 다시 시도해주세요." };

      res.json(response);
    }
  },

  logout: (req, res) => {
    ...
  },
};

export default { output, process };
```

![crypto-rds](/assets/img/crypto-rds.png){: .w-80 .normal}

데이터베이스에 암호화된 비밀번호가 담겨있는 것을 확인할 수 있습니다.

---

## passport 모듈

로그인 시 인증을 passport 모듈을 이용해 구현해보겠습니다.

기존에 방법은

---

## 참조

- <https://goodmemory.tistory.com/138>
- <https://velog.io/@rlorxl/JWT-express-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%98%EC%97%AC-%EB%A1%9C%EA%B7%B8%EC%9D%B8%EC%9D%84-%EA%B5%AC%ED%98%84%ED%95%B4%EB%B3%B4%EC%9E%90>
- <https://lakelouise.tistory.com/239?category=1033473>
