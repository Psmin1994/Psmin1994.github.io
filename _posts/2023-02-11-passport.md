---
title: passport 모듈
author: Psmin
data: 2023-02-11 18:41:16 +0900
categories: [Nodejs]
tags: [passport]
---

# passport 모듈에 대해 알아보자.

---

## passport 모듈

passport 모듈은 이름에서 알 수 있듯이 여권처럼 서비스를 이용할 수 있도록 사용자 인증을 구현할 때 사용합니다.

즉, Client가 Server에 서비스를 요청할 때 passport 모듈을 이용해 사용자 인증을 성공할 때만 응답해주는 것을 말합니다.

---

## passport 처리 과정

- 로그인 요청이 Route로 들어옵니다.
- 미들웨어들을 지난 후, `passport.authenticate() 메서드`를 호출합니다.
- `authenticate 메서드`는 사용자가 가져온 Strategy를 호출합니다. (**_config/passport/localStrategy.js_**)
- `Strategy`를 실행하고 `done() 메서드`를 호출해 다시 `passport.authenticate() 메서드`로 돌아갑니다.
- 실행된 `done() 함수`의 인자에 따라 여러 동작을 실행합니다.
  ![passport-done](/assets/img/passport-done.png){: .w-80 .normal}
- 로그인 성공 시 사용자 정보 객체와 함께 `req.logIn()`를 자동으로 호출합니다.
- `req.logIn` 메서드가 `passport.serializeUser()` 호출합니다. (**_passport/index.js_**)
- `req.session`에 `user.id`를 저장합니다.
- `passport.deserializeUser()`로 넘어가 DB 조회를 통해 `req.user` 를 등록한 후, `done() 메서드`를 반환하여 `req.logIn`으로 돌아갑니다.
- 미들웨어 처리 후, 세션 쿠키를 브라우저에 보냅니다.

---

## Strategy 전략

passport.js에서 다양한 인증 방법을 strategy로 제공합니다. 공식문서를 보면 다양한 strategy가 존재함을 볼 수 있습니다.

- [Passport.js]<http://www.passportjs.org/packages/>

사용자는 필요따라 원하는 Strategy를 가져와 사용할 수 있습니다.

1. **_Local Strategy (passport-local 모듈)_** : 로컬 데이터베이스에서 로그인 인증 방식
2. **_Social Strategy (passport-kakao, passport-twitter 등)_** : 소셜 네트워크 로그인 인증 방식

---

## 로그인 예제

---

### passport-local

우리는 기본적인 사용자 **_id_**와 **_passport_**를 이용한 인증 방법인 **_local strategy_**를 사용해보겠습니다.

- 설치

  ```console
  npm i express-session passport-local passport
  ```

- 미들웨어 등록

  ```js
  // app.js
  ...
  const passport = require('passport');

  ...
  const passportConfig = require('./config/passport/index.js');

  ...
  const authRouter = require('./routes/auth'); // 인증 라우터

  const app = express();
  passportConfig(); // 패스포트 설정

  ...
  app.use(cookieParser(process.env.COOKIE_SECRET));
  app.use(
     session({
        resave: false,
        saveUninitialized: false,
        secret: process.env.COOKIE_SECRET,
        cookie: {
           httpOnly: true,
           secure: false,
        },
     }),
  );

  //! express-session에 의존하므로 뒤에 위치해야 함
  app.use(passport.initialize()); // 요청 객체에 passport 설정을 심음
  app.use(passport.session()); // req.session 객체에 passport정보를 추가 저장
  // passport.session()이 실행되면, 세션쿠키 정보를 바탕으로 해서 passport/index.js의 deserializeUser()가 실행하게 한다.

  //* 라우터
  app.use('/auth', authRouter);

  ...

  ```

---

###
