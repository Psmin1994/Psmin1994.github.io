---
title: 로그인 페이지 만들기 - 08 (passport)
author: Psmin
data: 2023-02-16 23:07:02 +0900
categories: [Project, Login Page]
tags: [passport, passport-local]
---

# passport 패키지를 활용해 사용자 id와 passport를 이용한 기본적인 인증 방식을 구현해보자.

---

## passport 모듈

추후에 SSO를 사용하여 사용자 로그인을 구현할 예정이므로 passport 모듈을 이용해 로그인 기능을 구현해보겠습니다.

---

### 모듈 설치 및 연결

- 설치
  ```console
  npm i passport passport-local
  ```

`app.js` 파일에 passport 모듈을 연결해줍니다.

```js
...

import sessionMiddleware from "./src/middlewares/session.js";
import passport from "passport";
import passportConfig from "./src/config/passport/index.js";


const app = express();
passportConfig();

const __dirname = path.resolve();


...

app.use(sessionMiddleware);
// express-session에 의존하므로 뒤에 작성합니다.
app.use(passport.initialize()); // req 객체에 passport 설정을 입력
app.use(passport.session()); // req.session 객체에 passport정보를 추가 저장
// passport.session()이 실행되면, 세션쿠키 정보를 바탕으로 해서 passport/index.js의 deserializeUser()가 실행됩니다.

...


```

---

### config/passport 작성

먼저 `config/passport/index.js` 에 **serializeUser**와 **deserializeUser**를 작성합니다.

```js
// config/passport/index.js
import passport from "passport";
import local from "./localStrategy.js";

import UserStorage from "../../models/model_user.js";

export default () => {
  passport.serializeUser((req, user, done) => {
    done(null, user.id);
    // 자원낭비를 줄이기 위해 id만 저장합니다.
  });

  passport.deserializeUser(async (req, id, done) => {
    try {
      const user = await UserStorage.getUserInfo(id);

      done(null, user);
    } catch (err) {
      done(err);
    }
  });

  local();
};
```

다음 `localStrategy.js` 파일에 id + password로 인증하는 전략을 작성합니다.

```js
// config/passport/localStrategy.js
import passport from "passport";
import { Strategy as LocalStrategy } from "passport-local";
import { userPasswordVerify } from "../../middleware/crypto.js";

import UserStorage from "../../models/model_user.js";

export default () => {
  passport.use(
    "local-login",
    new LocalStrategy(
      {
        usernameField: "id",
        passwordField: "password",
      },
      async (id, password, done) => {
        try {
          const user = await UserStorage.getUserInfo(id);

          if (user) {
            const result = await userPasswordVerify(password, user.password);

            if (result) {
              done(null, user);
            } else {
              done(null, false, {
                success: false,
                msg: "비밀번호가 틀렸습니다.",
              });
            }
          } else {
            done(null, false, {
              success: false,
              msg: "가입되지 않은 회원입니다.",
            });
          }
        } catch (err) {
          done(err);
        }
      }
    )
  );
};
```

---

### isLogin.js 미들웨어 작성

현재 로그인 상태인지 아닌지 확인하는 미들웨어를 작성합니다.

```js
// middleware/isLogin.js
// 사용자 미들웨어를 직접 구현

export const isLoggedIn = (req, res, next) => {
  // isAuthenticated()로 검사해 로그인이 되어있으면
  if (req.isAuthenticated()) {
    next(); // 다음 미들웨어
  } else {
    res.status(403).send("로그인 필요");
  }
};

export const isNotLoggedIn = (req, res, next) => {
  if (!req.isAuthenticated()) {
    next(); // 로그인 안되어있으면 다음 미들웨어
  } else {
    res.status(403).send("로그인 상태");
  }
};
```

---

### route 작성

routes에서 controller로 넘어가기전 isLogin 미들웨어를 거쳐갑니다.

```js
import express from "express";
import ctrl_user from "../controllers/controller_user.js";
import validator_user from "./validator/validator_user.js";
import { isLoggedIn, isNotLoggedIn } from "../middleware/isLogin.js";

const Router = express.Router();

Router.get("/login", ctrl_user.output.login);
Router.get("/register", isNotLoggedIn, ctrl_user.output.register);
Router.get("/logout", isLoggedIn, ctrl_user.process.logout);

Router.post(
  "/login",
  validator_user.login,
  isNotLoggedIn,
  ctrl_user.process.login
);
Router.post(
  "/register",
  validator_user.register,
  isNotLoggedIn,
  ctrl_user.process.register
);

export default Router;
```

---

### Controller 파일 수정

기존에 Controller에서 if 문과 response 객체를 활용해 인증했던 작업을 passport 모듈을 이용해서 작성합니다.

Controller가 조금 더 간결한 코드로 작성된 것을 확인할 수 있습니다.  
(크게 차이는 없지만 추가로 카카오, 네이버 등으로 로그인 기능을 확장이 쉬운 장점이 있습니다.)

```js
import passport from "passport";
import {
  createPasswordAndSalt,
} from "../middleware/crypto.js";
import UserStorage from "../models/model_user.js";

const output = {
  login: (req, res) => {
    res.render("user/login", { name: req.user ? req.user.name : null });
  },

  register: ...,
};

const process = {
  login: (req, res, next) => {
    passport.authenticate("local-login", (err, user, response) => {
      if (err) return next(err);

      if (!user) return res.json(response);

      return req.login(user, (loginErr) => {
        if (loginErr) return next(loginErr);

        return res.json({ success: true });
      });
    })(req, res, next); // 미들웨어 내의 미들웨어에는 (req, res, next)를 붙입니다.
  },

  register: ...,

  logout: (req, res) => {
    req.session.destroy((err) => {
      if (err) throw err;
      // 세션 파괴후 할 것들
      res.redirect("/user/login");
    });
  },
};

export default { output, process };
```

---

## 참조

- <https://goodmemory.tistory.com/138>
- <https://velog.io/@rlorxl/JWT-express-%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%98%EC%97%AC-%EB%A1%9C%EA%B7%B8%EC%9D%B8%EC%9D%84-%EA%B5%AC%ED%98%84%ED%95%B4%EB%B3%B4%EC%9E%90>
- <https://lakelouise.tistory.com/239?category=1033473>
