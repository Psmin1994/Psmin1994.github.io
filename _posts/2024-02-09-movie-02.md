---
title: 영화 정보 제공 사이트 - 02
author: Psmin
data: 2024-02-09 22:44:37 +0900
categories: [Project, Movie Story]
tags: [Scraping]
---

# DB에 데이터를 추가해보자.

---

## 공공 데이터 활용

첫 번째 방법은 공공 데이터를 제공받을 수 있는 OPEN API를 활용해보는 것이였습니다.

영화진흥위원회의 오픈 API를 활용해보겠습니다.

> 사이트 링크 : [영화진흥위원화](https://www.kobis.or.kr/kobisopenapi/homepg/apiservice/searchServiceInfo.do?serviceId=searchMovieList)

- **첫번째 Get 요청 (일별 박스오피스 API)**

  `날짜(targetDt)`를 parameter로 해당 날짜의 상영 영화들의 대한 정보를 가져옵니다.

  > 사용할 데이터 : 개봉일, 누적관객수

- **두번째 Get 요청 (영화 상세 정보 API)**

  `영화 코드(movieCd)`를 parameter로 영화에 상세 정보 데이터를 가져옵니다.

  > 사용할 데이터 : 영화제목 한/영, 장르, 제작국가, 상영시간, 영화감독, 배우

- **요청 코드**

  ```js
  // 영화진흥위원회 공공 데이터 추출
  import axios from "axios";

  try {
    // 일별 박스오피스 API 요청 주소
    let url =
      "http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json";

    let dt = new Date();

    // 가져올 날짜 설정
    let today = `${dt.getFullYear()}${
      dt.getMonth() < 9 ? "0" + (dt.getMonth() + 1) : dt.getMonth() + 1
    }${dt.getDate() - 7}`;

    let res = await axios({
      method: "get",
      url: url,
      params: {
        key: "332ba9ce1cb2f258e6e32ab988458a6c",
        // parameter 로 날짜 지정
        targetDt: today,
      },
    }); // axios(url[, config]) 형태

    // kobis의 일별 박스오피스 Open API로 가져온 설정 날짜의 상영 영화 정보 배열
    let movieList = res.data.boxOfficeResult.dailyBoxOfficeList;

    console.log(movieList[0]);

    // 가져온 데이터에서 영화 상세 정보 데이터를 얻기 위해 영화 코드(movieCd)를 추출
    let movieCd = movieList[0].movieCd;

    // 영화 상세 정보 API 요청 주소
    url = `http://www.kobis.or.kr/kobisopenapi/webservice/rest/movie/searchMovieInfo.json`;

    res = await axios({
      method: "get",
      url: url,
      params: {
        key: "332ba9ce1cb2f258e6e32ab988458a6c",
        // 가져올 영화의 영화 코드 지정
        movieCd,
      },
    }); // axios(url[, config]) 형태

    console.log(res.data.movieInfoResult.movieInfo);
  } catch (err) {
    console.log(err);
  }
  ```

- **응답 데이터**

  ```js
  // 첫번째 응답
  {
    rnum: '1',
    rank: '1',
    rankInten: '0',
    rankOldAndNew: 'OLD',
    movieCd: '20236180', // 영화코드
    movieNm: '웡카',
    openDt: '2024-01-31', // 개봉일 (YYYY-MM-DD)
    salesAmt: '2288686938',
    salesShare: '54.6',
    salesInten: '1358999415',
    salesChange: '146.2',
    salesAcc: '5501692614',
    audiCnt: '226091',
    audiInten: '134065',
    audiChange: '145.7',
    audiAcc: '578105', // 누적관객수
    scrnCnt: '1751',
    showCnt: '8082'
  }

  // 두번째 응답
  {
    movieCd: '20236180',
    movieNm: '웡카',
    movieNmEn: 'Wonka',
    movieNmOg: '',
    showTm: '116',
    prdtYear: '2023',
    openDt: '20240131',
    prdtStatNm: '개봉',
    typeNm: '장편',
    nations: [ { nationNm: '미국' } ],
    genres: [ { genreNm: '판타지' }, { genreNm: '드라마' } ],
    directors: [ { peopleNm: '폴 킹', peopleNmEn: 'Paul King' } ],
    actors: [
      {
        peopleNm: '티모시 샬라메',
        peopleNmEn: 'Timothee Chalamet',
        cast: '',
        castEn: ''
      },
      {
        peopleNm: '칼라 레인',
        peopleNmEn: 'Calah Lane',
        cast: '',
        castEn: ''
      },
      {
        peopleNm: '올리비아 콜맨',
        peopleNmEn: 'Olivia Colman',
        cast: '',
        castEn: ''
      },
      {
        peopleNm: '톰 데이비스',
        peopleNmEn: 'Tom Davis',
        cast: '',
        castEn: ''
      },
      {
        peopleNm: '휴 그랜트',
        peopleNmEn: 'Hugh Grant',
        cast: '',
        castEn: ''
      },
      {
        peopleNm: '샐리 호킨스',
        peopleNmEn: 'Sally Hawkins',
        cast: '',
        castEn: ''
      }
    ],

    ...

  }
  ```

  - **개봉일** : `openDt (String)`
  - **누적관객수** : `audiAcc (String)`
  - **영화제목 한/영** : `movieNm (String)` / `movieNmEn (String)`
  - **장르** : `genres (Array)`
  - **제작국가** : `nations (Array)`
  - **상영시간** : `showTm (String)`
  - **영화감독** : `directors (Array)`
  - **배우** : `actors (Array)`

---

### 문제점

1. 현재 날짜에 대한 데이터를 제공하지않습니다.

2. 줄거리, 포스터사진 등 원하는 데이터를 따로 구해야한다.

3. OPEN API를 사용하기 위해 필요한 Key를 주기적으로 갱신해주어야한다.

이러한 단점으로 현재 개봉 중인 영화를 실시간으로 제공하려는 서비스에는 맞지 않습니다.

---

## 웹 스크래핑 (Scraping)

> 참고 글 : [puppeteer](https://psmin1994.github.io/posts/puppeteer/)

두 번째 방법으로 puppeteer를 사용한 웹 스크래핑을 활용해보겠습니다.

puppeteer란 **Node.js용 Chrome/Chrominm 제어 API**로 DevTools 프로토콜을 이용하여 브라우저를 제어할 수 있습니다.

[네이버](https://m.naver.com/)에서 현재 상영 영화에 대한 데이터를 추출해보겠습니다.

- `getList.js` : 네이버 홈페이지의 검색란에 **현재 상영 영화**를 검색하여 나온 영화 리스트에서 **a 태그의 href 속성**을 추출해 배열로 반환합니다.

- `insertData.js` : `getList.js`에서 반환한 href 배열을 하나씩 이동하여 영화 정보, 출연진 정보, 사진 등을 추출하여 DB에 삽입합니다.

- `getImgUrl.js` : DB에 이미지를 저장할 때 이미지 자체가 아닌 **이미지 파일의 경로를 문자열**로 저장하는데 해당 문자열을 반환하는 함수입니다.

- `getBoxOffice.js` : 일별 박스오피스 순위를 검색한 후 10위까지의 영화 제목을 추출하여 배열로 반환합니다.

---

### index.js

```js
import getList from "./getList.js";
import insertData from "./insertData.js";
import getBoxOffice from "./getBoxOffice.js";

let scraping = async () => {
  try {
    let [urlList, browser, page] = await getList();

    await insertData(urlList, page);

    let boxOfficeArr = await getBoxOffice(browser, page);

    return boxOfficeArr;
  } catch (err) {
    throw err;
  }
};

export default scraping;
```

---

### getList

```js
import puppeteer from "puppeteer";

var getList = async () => {
  try {
    let result = [];

    function sleep(ms) {
      var start = Date.now() + ms;
      while (Date.now() < start) {}
    }

    const crawlList = async () => {
      await page.waitForSelector(
        "div.cm_content_wrap > div > div > div > div.card_content._result_area > div.card_area._panel > div:last-child"
      );

      let movieList = await page.$$(
        "div.cm_content_wrap > div > div > div > div.card_content._result_area > div.card_area._panel > div"
      );

      for (let movie of movieList) {
        let href = await movie.$eval(
          "div.data_area > div > div.title > div > a",
          (el) => {
            return el.href;
          }
        );

        result.push(
          href[0] == "?" ? "https://search.naver.com/search.naver" + href : href
        );
      }
    };

    // 옵션으로 headless모드를 끌 수 있다.
    const browser = await puppeteer.launch({
      headless: true,
    });

    const page = await browser.newPage();

    await page.goto("https://www.naver.com/");

    await page.type("#query", `현재 상영 영화`);

    await page.click("#sform > fieldset > button");

    await page.waitForSelector(
      "div.card_content._result_area > div.cm_paging_area._page > div > span > span._total"
    );

    let pageNum = await page.$eval(
      "div.card_content._result_area > div.cm_paging_area._page > div > span > span._total",
      (el) => {
        return el.textContent;
      }
    );

    for (let i = 1; i < pageNum; i++) {
      await crawlList();

      await page.click(
        "div.card_content._result_area > div.cm_paging_area._page > div > a.pg_next.on._next"
      );

      sleep(1000);
    }

    await crawlList();

    await page.click(
      "div.list_type > div > div.title_area.type_keep > div > div > div > ul > li:nth-child(3) > a"
    );

    await crawlList();

    await page.click(
      "div.card_content._result_area > div.cm_paging_area._page > div > a.pg_next.on._next"
    );

    sleep(1000);

    await crawlList();

    return [result, browser, page];
  } catch (err) {
    throw err;
  }
};

export default getList;
```
