---
title: 로그인 페이지 만들기 - 10
author: Psmin
data: 2023-03-04 17:38:23 +0900
categories: [Project, Login Page]
tags: [XSS, CSRF]
---

# 웹 취약점을 보안해보자

---

## HTTP Only Cookie

브라우저에 저장된 쿠키는 클라이언트에서 Javascript로 조회가 가능합니다.

![cookie-no-option](/assets/img/cookie-no-option.png){: .w-80 .center}

XSS 공격은 서버 측에서 제공되는 Script가 아닌 **권한이 없는 사용자(이하 해커)가 웹사이트에 Script를 삽입**하여 의도치 않은 동작을 일으키는 것을 말합니다.

해커가 XSS 공격을 활용해 Cookie를 탈취해 사용한다면 서버는 로그인된 사용자로 요청을 처리하게 됩니다.

이를 막기위해 브라우저의 **쿠키를 접근하지 못하게 HTTP Only 옵션을 설정**합니다.

```js
res.cookie("accessToken", accessToken, {
  httpOnly: true,
});
```

클라이언트에서 조회되지 않는 것을 확인할 수 있습니다.

![cookie-http-only](/assets/img/cookie-http-only.png){: .w-80 .center}

---

## First-party cookie & Third-party cookie

쿠키는 유효한 사이트를 명시하기 위해 **Domain을 설정**할 수 있습니다.

퍼스트파티 쿠키는 **현재 접속해 있는 페이지와 같은 Domain으로 전송되는 쿠키**를 의미합니다.

서드파티 쿠키는 **현재 접속하고있는 페이지에서 다른 Domain으로 전송되는 쿠키**를 의미합니다.

---

## SameSite Cookie

쿠키에 별도로 설정을 가하지 않는다면 **모든 HTTP 요청에 대해서 쿠키를 전송**하게 됩니다.

CSRF(Cross Site Request Forgery)는 이 문제를 노린 공격으로 사용자의 **권한을 도용하여 특정 웹 사이트의 기능을 실행**합니다. ([CSRF 포스팅](https://psmin1994.github.io/posts/csrf/))

SameSite 옵션은 CSRF (Cross Site Request Forgery) 를 대응하기 위해 만들어진 기술입니다.

SameSite 쿠키의 정책으로 None, Lax, Strict 세 가지 종류를 선택할 수 있습니다.

- **None**  
  SameSite가 탄생하기 전 쿠키와 똑같이 서드 파티 쿠키도 항상 전송합니다.

- **Strict**

  퍼스트 파티 쿠키만 전송합니다.

- **Lax**

  퍼스트 파티 쿠키와 **Top Level Navigation (웹 페이지 이동)** 과, **안전한 HTTP 메서드 요청의 경우** 전송합니다.

  - 유저가 링크(`<a>`)를 클릭하거나, `window.location.replace` 등으로 인해 자동으로 이뤄지는 이동, 302 리다이렉트를 이용한 이동에느 쿠키가 전송됩니다.

  - `<iframe>`이나 `<img>`를 문서에 삽입함으로서 발생하는 HTTP 요청은 **Navigation**이라고 할 수 없으니 쿠키가 전송되지 않습니다.

  - `<iframe>` 안에서 페이지를 이동하는 경우는 **Top Level**이라고 할 수 없으므로 쿠키는 전송되지 않습니다.

  - 안전하지 않은 **POST**나 **DELETE** 같은 요청의 경우, 쿠키는 전송되지 않습니다.

  - **GET**처럼 서버의 상태를 바꾸지 않을 거라고 기대되는 요청에는 쿠키가 전송됩니다.

- **Samesite 옵션 적용**

  ```js
  res.cookie("accessToken", accessToken, {
    sameSite: "lax",
    httpOnly: true,
  });
  ```

---

## Secure Cookie

HTTP Only 옵션을 통해 브라우저에서 Javascript를 이용해 쿠키에 접근하지 못하도록 막았습니다.

하지만, Javascript가 아닌 네트워크를 직접 감청하여 쿠키를 가로챌 수도 있습니다.

요청 헤더에서 확인되는 것을 볼 수 있습니다.

![cookie-no-secure](/assets/img/cookie-no-secure.png){: .w-80 .center}

이를 막기 위해 **HTTPS 프로토콜을 사용해 데이터를 암호화**합니다.

즉, 쿠키 또한 암호화되어 전송되기 때문에 문제가 발생하지 않습니다.

Secure 옵션은 HTTPS 통신 외에서는 쿠키를 전달하지 않습니다.

현재는 Domain Name이 없기 떄문에 나중에 추가해주겠습니다.

---

이제 AccessToken에 옵션을 추가해서 발급합니다.

```js
// AccessToken 재발급
res.cookie("accessToken", newAccessToken, {
  sameSite: "lax",
  httpOnly: true,
  secure: false,
});
```
