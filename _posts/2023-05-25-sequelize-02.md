---
title: sequelize 모듈 - 02
author: Psmin
data: 2023-05-25 13:41:57 +0900
categories: [Knowledge, Nodejs]
tags: [sequelize]
---

## Sequelize 관계 정의하기

> 참고 글 : [Sequelize - associate](https://sequelize.org/docs/v6/core-concepts/assocs/)

Sequelize에서는 **테이블 간의 관계 (1:1, 1:N, N:M)를 정의**할 수 있습니다.

모델에 속하는 <kbd>BeingTo</kbd>, <kbd>hasOne</kbd>, <kbd>hasMany</kbd>, <kbd>BelongsToMany</kbd> 함수 중 하나를 호출하고 다른 모델을 첫 번째 인수로 제공하여 사용합니다.

---

### 1:N 관계

1:N 관계에서는 **hasMany**와 **belongsTo** 메서드를 사용합니다.

![sequelize-one-to-many](/assets/img/sequelize-one-to-many.png){: .w-80}

User와 Comment를 정의해보겠습니다.

한 User가 많은 댓글을 가질 수 있으니 **User.hasMany를 사용**하고, Comment는 한 User에 속할 수 있으니 **Comment.belongsTo를 사용**합니다.

즉, 외래키가 존재하는 테이블이 **belogsTo를 사용**합니다.

또한, 두 번째 매개변수로 다양한 옵션을 전달할 수 있습니다.

- **Options**

  - <kbd>ForeignKey</kbd> : 외래 키를 직접 명시

    > foreignKey를 따로 지정하지 않는다면 모델명+기본 키로 이름이 자동 설정됩니다.

  - <kbd>sourceKey</kbd> : `hasMany`에서 사용하며 외래 키로 전할 속성을 명시

  - <kbd>targetKey</kbd> : `belongsTo`에서 사용하며 외래 키로 가져올 속성을 명시

  - <kbd>onDelete</kbd>, <kbd>onUpdate</kbd> : 엔티티의 상태 변화를 전파시키는 옵션,
    (RESTRICT, CASCADE, NO ACTION, SET DEFAULT, SET NULL)

```js
db.User.hasMany(db.Comment, { foreignKey: "commenter", sourceKey: "id" });

db.Comment.belongsTo(db.User, { foreignKey: "commenter", targetKey: "id" });
```

---

### 1:1 관계

1:1 관계에서는 **hasOne**와 **belongsTo**를 사용합니다.

![sequelize-one-to-one](/assets/img/sequelize-one-to-one.png){: .w-80}

```js
Foo.hasOne(Bar);
Bar.belongsTo(Foo);
```

---

### M:N 관계

M:N 관계에서는 **belongsToMany**를 사용합니다.

- **Options**

  - <kbd>through</kbd> : 생성될 중간 모델(연결 테이블)의 이름을 명시

```js
// Post
db.Post.belongsToMany(db.Hashtag, { through: "PostHashtag" });

// Hashtag
db.Hashtag.belongsToMany(db.Post, { through: "PostHashtag" });
```

---

## models/posts.js 생성

models 폴더에 **_posts.js_** 파일을 생성합니다.

> User와 Post를 1 : N 관계로 설정해보겠습니다.

```js
// posts.js
import { DataTypes, Model } from "sequelize";

class Post extends Model {
  static init(sequelize) {
    return super.init(
      {
        post_id: {
          type: DataTypes.INTEGER,
          primaryKey: true,
          autoIncrement: true,
          allowNull: false,
          // unique
          // defaultValue
          // validate
        },
        title: {
          type: DataTypes.STRING(30),
          allowNull: false,
        },
        content: {
          type: DataTypes.STRING(30),
          allowNull: false,
        },
      },
      {
        sequelize, // Sequelize 인스턴스
        timestamps: false, // true : created_at, updated_at 컬럼이 생성되며 데이터의 생성, 수정 시 시간이 자동으로 입력됩니다.
        paranoid: false /* true : deletedAt 컬럼이 생성되며 지운 시각이 기록됩니다. */,
        underscored: true, // true : 카멜케이스 대신 스네이크케이스를 사용
        freezeTableName: true, // 모델이름 변환 X, 지정한 이름 사용
        ModelName: "Post", // 모델의 이름을 지정합니다.
        tableName: "posts", // 테이블 이름 명시적 설정
      }
    );
  }

  static associate(db) {
    db.Post.belongsTo(db.User, { foreignKey: "user_id", targetKey: "user_id" });
  }
}

export default Post;
```

---

## models/users.js

models 폴더의 **_users.js_** 파일에도 관계 설정 부분을 추가해줍니다.

```js
// users.js
import { DataTypes, Model } from "sequelize";

class User extends Model {
  static init(sequelize) {
    return super.init(
      {
        user_id: {
          type: DataTypes.INTEGER,
          primaryKey: true,
          autoIncrement: true,
          allowNull: false,
          // unique
          // defaultValue
          // validate
        },
        password: {
          type: DataTypes.STRING(30),
          allowNull: false,
        },
      },
      {
        sequelize, // Sequelize 인스턴스
        timestamps: false, // true : created_at, updated_at 컬럼이 생성되며 데이터의 생성, 수정 시 시간이 자동으로 입력됩니다.
        paranoid: false /* true : deletedAt 컬럼이 생성되며 지운 시각이 기록됩니다. */,
        underscored: true, // true : 카멜케이스 대신 스네이크케이스를 사용
        freezeTableName: true, // 모델이름 변환 X, 지정한 이름 사용
        modelName: "User", // 모델 이름 명시적 지정
        tableName: "users", // 테이블 이름 명시적 설정
      }
    );
  }

  static associate(db) {
    db.User.hasMany(db.Post, { foreignKey: "user_id", sourceKey: "user_id" });
  }
}

export default User;
```

---

## index.js 수정

```js
import Sequelize from "sequelize";

// 클래스를 불러옵니다.
import User from "./users.js";
import Post from "./posts.js";

const config = {
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_DATABASE,
  host: process.env.DB_HOST,
  dialect: "mysql",
};

const db = {};

// new Sequelize를 통해 MySQL 연결 객체를 생성합니다.
const sequelize = new Sequelize(
  config.database,
  config.username,
  config.password,
  config
);

// 연결객체를 나중에 재사용하기 위해 db.sequelize에 넣어줍니다.
db.sequelize = sequelize;

// 모델 클래스를 넣어줍니다.
db.User = User;
db.Post = Post;

// 모델 정의
User.init(sequelize);
Post.init(sequelize);

// 모델간의 관계 정의
User.associate(db);
Post.associate(db);

export default db;
```

---

## 연결 테스트

![sequelize-create-table-associate-01](/assets/img/sequelize-create-table-associate-01.png){: .w-80}

![sequelize-create-table-associate-02](/assets/img/sequelize-create-table-associate-02.png){: .w-80}

에러 없이 posts 테이블에 외래 키로 <kbd>user_id</kbd>가 잘 생성된 것을 확인할 수 있습니다.

---

## Sequelize로 CRUD
