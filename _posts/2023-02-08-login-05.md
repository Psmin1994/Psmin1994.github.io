---
title: ë¡œê·¸ì¸ í˜ì´ì§€ ë§Œë“¤ê¸° - cookie & session
author: Psmin
data: 2023-02-08 16:41:12 +0900
categories: [Nodejs]
tags: [session]
---

# ì¿ í‚¤ì™€ ì„¸ì…˜ì„ í™œìš©í•´ ìë™ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì.

---

## ì¿ í‚¤ì™€ ì„¸ì…˜ìœ¼ë¡œ ê¸°ëŠ¥ êµ¬í˜„

cookie-parser ëª¨ë“ˆê³¼ express-session ëª¨ë“ˆì„ í™œìš©í•©ë‹ˆë‹¤.  
(ì´ì „ í¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë³´ì‹œë©´ ì´í•´í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.ğŸ˜‰)

1. ë¨¼ì € `app.js` íŒŒì¼ì— `cookie-parser ëª¨ë“ˆ`ì„ importí•´ ë¯¸ë“¤ì›¨ì–´ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.

   ```js
   import express from "express";
   import bodyParser from "body-parser";
   import path from "path";
   import dotenv from "dotenv";
   import morganMiddleware from "./src/middleware/morgan.js";
   import userRouter from "./src/routes/route_user.js";
   import cookieParser from "cookie-parser";

   dotenv.config();
   const app = express();
   const __dirname = path.resolve();

   // ì •ì  íŒŒì¼
   app.use("/", express.static(`${__dirname}/src/public`));

   // ì•± ì„¸íŒ…
   app.set("views", "./src/views");
   app.set("view engine", "ejs");

   // ë¯¸ë“¤ì›¨ì–´
   app.use(bodyParser.json());
   app.use(bodyParser.urlencoded({ extended: true }));
   app.use(cookieParser(process.env.COOKIE_SECRET));
   // cookieParser ë©”ì„œë“œì— ì¸ìë¡œ ì£¼ì–´ì§€ëŠ” secretì€ í™˜ê²½ë³€ìˆ˜ë¡œ ë”°ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
   app.use(morganMiddleware);

   // router
   app.use("/user", userRouter);

   // 3000 í¬íŠ¸ë¡œ ì„œë²„ ì˜¤í”ˆ
   app.listen(3000, () => {
     console.log("express server on port 3000");
   });
   ```

2. sessionì€ middleware í´ë”ì— `session.js` íŒŒì¼ì„ ë§Œë“¤ì–´ ëª¨ë“ˆí™”í•´ì„œ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.

   ì„¸ì…˜ ìŠ¤í† ì–´ë¡œ mysqlì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `express-mysql-session ëª¨ë“ˆ`ì„ ì„¤ì¹˜í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.

   ```js
   import session from "express-session";
   import mysqlStore from "express-mysql-session";

   const mysqlStoreSession = mysqlStore(session);

   const options = {
     host: process.env.DB_HOST, //ì‹¤ì œë¡œ ì—°ê²°í•  ë°ì´í„°ë² ì´ìŠ¤ì˜ ìœ„ì¹˜
     user: process.env.DB_USER,
     password: process.env.DB_PASSWORD,
     port: process.env.DB_PORT,
     database: process.env.DB_DATABASE,
     clearExpired: true, // ë§Œë£Œëœ ì„¸ì…˜ ìë™ ì‚­ì œ ê¸°ëŠ¥
     checkExpirationInterval: 30 * 60 * 1000, // 30ë¶„ ,ë§Œë£Œëœ ì„¸ì…˜ì´ ì§€ì›Œì§€ëŠ” ë¹ˆë„ (ë°€ë¦¬ì´ˆ)
     createDatabaseTable: true,
     expiration: 1 * 60 * 60 * 1000, // 1ì‹œê°„, ìœ íš¨í•œ ì„¸ì…˜ì˜ ìµœëŒ€ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
     schema: {
       tableName: "sessions",
       columnNames: {
         session_id: "session_id",
         expires: "expires",
         data: "data",
       },
     },
   };

   const sessionStore = new mysqlStoreSession(options);

   sessionStore
     .onReady()
     .then(() => {
       // ì„¸ì…˜ ìŠ¤í† ì–´ ì¤€ë¹„ ì™„ë£Œ
       console.log("MySQLStore ready");
     })
     .catch((err) => {
       // ì—ëŸ¬ ë°œìƒ
       console.error(err);
     });

   export default session({
     secure: true, // https í™˜ê²½ì—ì„œë§Œ session ì •ë³´ ì²˜ë¦¬
     secret: process.env.COOKIE_SECRET, // ì•”í˜¸í™”í•˜ëŠ” ë° ì“°ì¼ í‚¤
     resave: false, // ì„¸ì…˜ì„ ì–¸ì œë‚˜ ì €ì¥í• ì§€
     saveUninitialized: false,
     name: "sessionId",
     store: sessionStore,
     cookie: {
       maxAge: 24 * 60 * 60 * 1000, // ì¿ í‚¤ ìœ íš¨ê¸°ê°„ 24ì‹œê°„
     },
   });
   ```

3. `app.js` íŒŒì¼ì— ì •ì˜í•œ sessionì„ importí•´ ë¯¸ë“¤ì›¨ì–´ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.

   ```js
   import express from "express";
   import bodyParser from "body-parser";
   import path from "path";
   import dotenv from "dotenv";
   import userRouter from "./src/routes/route_user.js";
   import cookieParser from "cookie-parser";
   import morganMiddleware from "./src/middleware/morgan.js";
   import sessionMiddleware from "./src/middleware/session.js";

   dotenv.config();
   const app = express();
   const __dirname = path.resolve();

   // ì •ì  íŒŒì¼
   app.use("/", express.static(`${__dirname}/src/public`));

   // ì•± ì„¸íŒ…
   app.set("views", "./src/views");
   app.set("view engine", "ejs");

   // ë¯¸ë“¤ì›¨ì–´
   app.use(bodyParser.json());
   app.use(bodyParser.urlencoded({ extended: true }));
   app.use(cookieParser(process.env.COOKIE_SECRET));
   app.use(morganMiddleware);
   app.use(sessionMiddleware);

   // router
   app.use("/user", userRouter);

   // 3000 í¬íŠ¸ë¡œ ì„œë²„ ì˜¤í”ˆ
   app.listen(3000, () => {
     console.log("express server on port 3000");
   });
   ```

{: .prompt-info}

> ì„¸ì…˜ê³¼ ì¿ í‚¤ë¥¼ ë¯¸ë“¤ì›¨ì–´ë¡œ ë“±ë¡í–ˆìœ¼ë‹ˆ ìë™ ë¡œê·¸ì¸ ê¸°ëŠ¥ê³¼ ì‚¬ìš©ìì˜ idë¥¼ ì¶œë ¥í•˜ëŠ” í˜ì´ì§€ë¥¼ êµ¬í˜„í•´ë³´ê² ìŠµë‹ˆë‹¤.

---

### ìë™ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„

- POST ë°©ì‹ìœ¼ë¡œ loginì„ ìš”ì²­í•  ë•Œ ë¡œê·¸ì¸ ì„±ê³µí–ˆë‹¤ë©´ ì„¸ì…˜ì— is_logined ê°’ì„ trueë¡œ nickname ê°’ê³¼ í•¨ê»˜ ì €ì¥í•©ë‹ˆë‹¤.

- GET ë°©ì‹ìœ¼ë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ìš”ì²­í–ˆì„ ë•Œ ì„¸ì…˜ì˜ is_logined ê°’ì„ í™•ì¸í•˜ê³  trueë¼ë©´ is_logined ê°’ê³¼ nickname ê°’ì„ ë³´ëƒ…ë‹ˆë‹¤.

- `session.destroy` ë©”ì„œë“œë¥¼ ì´ìš©í•´ sessionì„ ì‚­ì œí•˜ëŠ” logout ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

```js
import logger from "../middleware/logger.js";
import UserStorage from "../models/model_user.js";

const output = {
  login: (req, res) => {
    // is_logined ê°’ í™•ì¸
    if (req.session.is_logined === true) {
      // true ë¼ë©´ ìë™ ë¡œê·¸ì¸ë˜ì–´ ë°”ë¡œ ì •ë³´ í˜ì´ì§€ ë Œë”ë§
      res.render("user/login", {
        is_logined: req.session.is_logined,
        nickname: req.session.nickname,
      });
    } else {
      // ë¡œê·¸ì¸ í˜ì´ì§€ ë Œë”ë§
      res.render("user/login", {
        is_logined: false,
      });
    }
  },

  register: async (req, res) => {
    res.render("user/register");
  },
};

const process = {
  login: async (req, res) => {
    try {
      const { id, password, nickname } = await UserStorage.getUserInfo(
        req.body.id
      );

      var response = {};

      if (id) {
        if (id === req.body.id && password === req.body.password) {
          // ë¡œê·¸ì¸ ì„±ê³µ í–ˆì„ ë•Œ
          req.session.is_logined = true;
          req.session.nickname = nickname;

          response = { success: true };
        } else {
          response = { success: false, msg: "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤." };
        }
      } else {
        response = { success: false, msg: "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤." };
      }

      res.json(response);
    } catch (err) {
      const response = {
        success: false,
        msg: "ë¡œê·¸ì¸ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
      };

      res.json(response);
    }
  },

  register: async (req, res) => {
    try {
      const check = await UserStorage.getUserInfo(req.body.id);
      var response = {};

      if (check) {
        response = { success: false, msg: "ì•„ì´ë””ê°€ ì¡´ì¬í•©ë‹ˆë‹¤." };
      } else {
        response = await UserStorage.createUser(req.body);
      }

      res.json(response);
    } catch (err) {
      const response = {
        success: false,
        msg: "íšŒì›ê°€ì…ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
      };

      res.json(response);
    }
  },

  logout: (req, res) => {
    req.session.destroy((err) => {
      if (err) throw err;
      // ì„¸ì…˜ íŒŒê´´í›„ í•  ê²ƒë“¤
      res.redirect("/user/login");
    });
  },
};

export default { output, process };
```

- login.ejs íŒŒì¼ì„ ìˆ˜ì •í•´ is_logined ê°’ì„ í™•ì¸í•´ trueë¼ë©´, ìë™ ë¡œê·¸ì¸ìœ¼ë¡œ ì‚¬ìš©ìì˜ idë¥¼ ì¶œë ¥í•˜ê³  falseë¼ë©´ ì¼ë°˜ì ì¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” ì½”ë“œë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.

- body ë¶€ë¶„ì— ì¡°ê±´ë¬¸ì„ ê±¸ì–´ ê°’ì„ í™•ì¸í•˜ê³  ì¶œë ¥í•©ë‹ˆë‹¤.

```html
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="#" type="image/x-icon" />

    <!-- CSS link -->
    <link rel="stylesheet" href="/css/user/login.css" />

    <!-- script ì‚½ì… -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.5/axios.min.js"
      integrity="sha512-nnNHpffPSgINrsR8ZAIgFUIMexORL5tPwsfktOTxVYSv+AUAILuFYWES8IHl+hhIhpFGlKvWFiz9ZEusrPcSBQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script defer src="/js/user/login.js" type="module"></script>

    <title>ë¡œê·¸ì¸ í˜ì´ì§€</title>
  </head>
  <body>
    <div class="login-page">
      <!-- EJS ë¬¸ë²•ìœ¼ë¡œ ì¡°ê±´ë¬¸ì„ ê±¸ì–´ is_logined ê°’ì„ í™•ì¸í•©ë‹ˆë‹¤. -->
      <div class="form">
        <% if (is_logined == false) { %>
        <form class="login-form">
          <input id="id" type="id" placeholder="ì•„ì´ë””" />
          <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <p id="button">LOGIN</p>
          <p class="message">
            Not registered? <a href="/user/register">Create an account</a>
          </p>
        </form>
        <% } else { %>
        <ul>
          <li><%= nickname %>ë‹˜</li>
          <li><a href="/user/logout">logout</a></li>
        </ul>
        <% } %>
      </div>
    </div>
  </body>
</html>

<!-- Copyright (c) 2022 by Aigars Silkalns (https://codepen.io/colorlib/pen/rxddKy) -->
```
