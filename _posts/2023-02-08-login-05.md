---
title: 로그인 페이지 만들기 - 05
author: Psmin
data: 2023-02-08 16:41:12 +0900
categories: [Nodejs]
tags: [session, validation]
---

# 여러 모듈을 활용해 로그인 기능을 구현해보자.

---

## 쿠키와 세션으로 기능 구현

cookie-parser 모듈과 express-session 모듈을 활용합니다.  
(이전 포스트를 먼저 보시면 이해하기 쉽습니다.😉)

1. 먼저 `app.js` 파일에 `cookie-parser 모듈`을 import해 미들웨어로 등록합니다.

   ```js
   import express from "express";
   import bodyParser from "body-parser";
   import path from "path";
   import dotenv from "dotenv";
   import morganMiddleware from "./src/middleware/morgan.js";
   import userRouter from "./src/routes/route_user.js";
   import cookieParser from "cookie-parser";

   dotenv.config();
   const app = express();
   const __dirname = path.resolve();

   // 정적 파일
   app.use("/", express.static(`${__dirname}/src/public`));

   // 앱 세팅
   app.set("views", "./src/views");
   app.set("view engine", "ejs");

   // 미들웨어
   app.use(bodyParser.json());
   app.use(bodyParser.urlencoded({ extended: true }));
   app.use(cookieParser(process.env.COOKIE_SECRET));
   // cookieParser 메서드에 인자로 주어지는 secret은 환경변수로 따로 관리합니다.
   app.use(morganMiddleware);

   // router
   app.use("/user", userRouter);

   // 3000 포트로 서버 오픈
   app.listen(3000, () => {
     console.log("express server on port 3000");
   });
   ```

2. session은 middleware 폴더에 `session.js` 파일을 만들어 모듈화해서 사용하겠습니다.

   세션 스토어로 mysql을 사용하기 위해 `express-mysql-session 모듈`을 설치해 사용합니다.

   ```js
   import session from "express-session";
   import mysqlStore from "express-mysql-session";

   const mysqlStoreSession = mysqlStore(session);

   const options = {
     host: process.env.DB_HOST, //실제로 연결할 데이터베이스의 위치
     user: process.env.DB_USER,
     password: process.env.DB_PASSWORD,
     port: process.env.DB_PORT,
     database: process.env.DB_DATABASE,
     clearExpired: true, // 만료된 세션 자동 삭제 기능
     checkExpirationInterval: 30 * 60 * 1000, // 30분 ,만료된 세션이 지워지는 빈도 (밀리초)
     createDatabaseTable: true,
     expiration: 1 * 60 * 60 * 1000, // 1시간, 유효한 세션의 최대 시간 (밀리초)
     schema: {
       tableName: "sessions",
       columnNames: {
         session_id: "session_id",
         expires: "expires",
         data: "data",
       },
     },
   };

   const sessionStore = new mysqlStoreSession(options);

   sessionStore
     .onReady()
     .then(() => {
       // 세션 스토어 준비 완료
       console.log("MySQLStore ready");
     })
     .catch((err) => {
       // 에러 발생
       console.error(err);
     });

   export default session({
     secure: true, // https 환경에서만 session 정보 처리
     secret: process.env.COOKIE_SECRET, // 암호화하는 데 쓰일 키
     resave: false, // 세션을 언제나 저장할지
     saveUninitialized: false,
     name: "sessionId",
     store: sessionStore,
     cookie: {
       maxAge: 24 * 60 * 60 * 1000, // 쿠키 유효기간 24시간
     },
   });
   ```

3. `app.js` 파일에 정의한 session을 import해 미들웨어로 등록합니다.

   ```js
   import express from "express";
   import bodyParser from "body-parser";
   import path from "path";
   import dotenv from "dotenv";
   import userRouter from "./src/routes/route_user.js";
   import cookieParser from "cookie-parser";
   import morganMiddleware from "./src/middleware/morgan.js";
   import sessionMiddleware from "./src/middleware/session.js";

   dotenv.config();
   const app = express();
   const __dirname = path.resolve();

   // 정적 파일
   app.use("/", express.static(`${__dirname}/src/public`));

   // 앱 세팅
   app.set("views", "./src/views");
   app.set("view engine", "ejs");

   // 미들웨어
   app.use(bodyParser.json());
   app.use(bodyParser.urlencoded({ extended: true }));
   app.use(cookieParser(process.env.COOKIE_SECRET));
   app.use(morganMiddleware);
   app.use(sessionMiddleware);

   // router
   app.use("/user", userRouter);

   // 3000 포트로 서버 오픈
   app.listen(3000, () => {
     console.log("express server on port 3000");
   });
   ```

{: .prompt-info}

> 세션과 쿠키를 미들웨어로 등록했으니 자동 로그인 기능과 사용자의 id를 출력하는 페이지를 구현해보겠습니다.

---

### 자동 로그인 기능 구현

- POST 방식으로 login을 요청할 때 로그인 성공했다면 세션에 is_logined 값을 true로 name 값에 id를 저장합니다.

- GET 방식으로 로그인 페이지를 요청했을 때 세션의 is_logined 값을 확인하고 true라면 is_logined 값과 name 값을 보냅니다.

- `session.destroy` 메서드를 이용해 session을 삭제하는 logout 기능을 구현합니다.

```js
import logger from "../middleware/logger.js";
import UserStorage from "../models/model_user.js";

const output = {
  login: (req, res) => {
    // is_logined 값 확인
    if (req.session.is_logined === true) {
      // true 라면 자동 로그인되어 바로 정보 페이지 렌더링
      res.render("user/login", {
        is_logined: req.session.is_logined,
        id: req.session.name,
      });
    } else {
      // 로그인 페이지 렌더링
      res.render("user/login", {
        is_logined: false,
      });
    }
  },

  register: async (req, res) => {
    res.render("user/register");
  },
};

const process = {
  login: async (req, res) => {
    try {
      const { id, password } = await UserStorage.getUserInfo(req.body.id);

      var response = {};

      if (id) {
        if (id === req.body.id && password === req.body.password) {
          // 로그인 성공 했을 때
          req.session.is_logined = true;
          req.session.name = id;

          response = { success: true };
        } else {
          response = { success: false, msg: "비밀번호가 틀렸습니다." };
        }
      } else {
        response = { success: false, msg: "존재하지 않는 아이디입니다." };
      }

      res.json(response);
    } catch (err) {
      const response = {
        success: false,
        msg: "로그인을 할 수 없습니다.\n잠시 후 다시 시도해주세요.",
      };

      res.json(response);
    }
  },

  register: async (req, res) => {
    try {
      const check = await UserStorage.getUserInfo(req.body.id);
      var response = {};

      if (check) {
        response = { success: false, msg: "아이디가 존재합니다." };
      } else {
        response = await UserStorage.createUser(req.body);
      }

      res.json(response);
    } catch (err) {
      const response = {
        success: false,
        msg: "회원가입을 할 수 없습니다.\n 잠시 후 다시 시도해주세요.",
      };

      res.json(response);
    }
  },

  logout: (req, res) => {
    req.session.destroy((err) => {
      if (err) throw err;
      // 세션 파괴후 할 것들
      res.redirect("/user/login");
    });
  },
};

export default { output, process };
```

- login.ejs 파일을 수정해 is_logined 값을 확인해 true라면, 자동 로그인으로 사용자의 id를 출력하고 false라면 일반적인 로그인 페이지를 보여주는 코드로 수정합니다.

- body 부분에 조건문을 걸어 값을 확인하고 출력합니다.

```html
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="#" type="image/x-icon" />

    <!-- CSS link -->
    <link rel="stylesheet" href="/css/user/login.css" />

    <!-- script 삽입 -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.5/axios.min.js"
      integrity="sha512-nnNHpffPSgINrsR8ZAIgFUIMexORL5tPwsfktOTxVYSv+AUAILuFYWES8IHl+hhIhpFGlKvWFiz9ZEusrPcSBQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script defer src="/js/user/login.js" type="module"></script>

    <title>로그인 페이지</title>
  </head>
  <body>
    <div class="login-page">
      <!-- EJS 문법으로 조건문을 걸어 is_logined 값을 확인합니다. -->
      <div class="form">
        <% if (is_logined == false) { %>
        <form class="login-form">
          <input id="id" type="id" placeholder="아이디" />
          <input id="password" type="password" placeholder="비밀번호" />
          <p id="button">LOGIN</p>
          <p class="message">
            Not registered? <a href="/user/register">Create an account</a>
          </p>
        </form>
        <% } else { %>
        <ul>
          <li><%= id %>님</li>
          <li><a href="/user/logout">logout</a></li>
        </ul>
        <% } %>
      </div>
    </div>
  </body>
</html>

<!-- Copyright (c) 2022 by Aigars Silkalns (https://codepen.io/colorlib/pen/rxddKy) -->
```

---

## 유효성 검사 해보기

express-validator 모듈을 활용해 POST 요청으로 로그인, 회원가입을 요청할 때 데이터가 서버나 데이터베이스 보내지기 전에 조건에 부합하는지 확인, 검증하는 작업을 구현해보겠습니다.
