---
title: mysql ëª¨ë“ˆë“¤
author: Psmin
data: 2022-01-01 20:35:21 +0900
categories: [Nodejs]
tags: [mysql, mysql2]
---

# mysql ê´€ë ¨ ëª¨ë“ˆë“¤ì— ëŒ€í•´ ì•Œì•„ë³´ì.

---

## í…Œì´ë¸” ìƒì„±

ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ, íšŒì›ê°€ì… ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ users í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.

![users-table](/assets/img/users-table.png){: .w-80 .normal}

---

## mysql ëª¨ë“ˆ

mysql ëª¨ë“ˆì€ node.jsê°€ mysqlì˜ í´ë¼ì´ì–¸íŠ¸ë¡œ ì‘ë™í•´ mysql ì„œë²„ì— ì ‘ì†í•´ì„œ ì¿¼ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ëª¨ë“ˆì…ë‹ˆë‹¤.

- ì„¤ì¹˜
  ```js
  npm i mysql
  ```

---

### createConnection ë©”ì„œë“œ

ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ê³  createConnection ë©”ì„œë“œì˜ ì¸ìë¡œ ì „ë‹¬ë˜ëŠ” ê°ì²´ì— ë°ì´í„°ë² ì´ìŠ¤ì˜ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.

query() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì›í•˜ëŠ” ì‘ì—…ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

query ë©”ì„œë“œëŠ” query([SQLë¬¸], [SQLë¬¸ ì‹¤í–‰í•œ ê²°ê³¼ë¥¼ ë°›ëŠ” ì½œë°± í•¨ìˆ˜]) í˜•íƒœë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```js
import mysql from "mysql";

const password = process.env.DB_PASSWORD;

let conn = mysql.createConnection({
  host: "localhost", // AWS RDSì˜ ì—”ë“œí¬ì¸íŠ¸
  user: "psmin", // AWS RDSì˜ ë§ˆìŠ¤í„° ì´ë¦„
  password: password, // AWS RDSì˜ ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸
  database: "user", // ì‚¬ìš©í•  ìŠ¤í‚¤ë§ˆ(ë°ì´í„°ë² ì´ìŠ¤) ì´ë¦„
  port: 3306,
});

conn.query("SELECT * FROM users", (err, result, fields) => {
  if (err) console.log(err);

  console.log(results);
});

conn.end();
```

ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ê°ì²´ë¡œ ë°ì´í„°ë¥¼ ë°›ìŠµë‹ˆë‹¤.

![mysql-createconnection](/assets/img/mysql-createconnection.png){: .w-80 .normal}

---

## ì»¤ë„¥ì…˜ í’€ (Connection Pool)

Queryë¥¼ ë³´ë‚¼ ë•Œë§ˆë‹¤ Connectionì„ í•˜ëŠ” ë°©ì‹ì¸ createConnection ë©”ì„œë“œëŠ” ì—¬ëŸ¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë™ì‹œ ìš”ì²­ì´ ë§ì•„ì ¸ ìˆ˜ìš©ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**_ì¿¼ë¦¬ë¬¸ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ Connectionì„ ìƒì„±í•˜ëŠ” ê²ƒ_**ì´ ë¹„íš¨ìœ¨ì ì´ê¸° ë•Œë¬¸ì— ë“±ì¥í•œ ë°©ì‹ì´ Connection Poolë°©ì‹ì…ë‹ˆë‹¤.

- <kbd>ê¸°ì¡´ ë°©ì‹</kbd>
  ![db-connection-01](/assets/img/db-connection-01.png){: .w-80 .normal}

- <kbd>Connection Pool ë°©ì‹</kbd>
  ![db-connection-02](/assets/img/db-connection-02.png){: .w-80 .normal}

Connection Poolì€ í•˜ë‚˜ì˜ Poolì„ ìƒì„±í•œ ë’¤ ì§€ì •í•œ ìˆ˜ ë§Œí¼ Connectionì„ ë¯¸ë¦¬ í• ë‹¹í•©ë‹ˆë‹¤.

Clientì—ì„œ DBì— ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸°ìœ„í•œ Connectionì„ Poolì—ì„œ ê°€ì ¸ì™€ ì‚¬ìš©í•œ ë’¤
ë‹¤ì‹œ Poolì— Connectionì„ ë°˜í™˜í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ë°©ì‹ì€ ë™ì‹œ ìš”ì²­ ìˆ˜ê°€ ë§ì•„ì ¸ë„ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•Šê³  Poolì— ë‚¨ì•„ìˆëŠ” Connectionì´ ì—†ë‹¤ë©´ ëŒ€ê¸°ìƒíƒœê°€ ë˜ê³  ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ `Connection`ì´ ë°˜í™˜ë˜ë©´ ëŒ€ê¸°ìƒíƒœê°€ í’€ë¦¬ê²Œ ë©ë‹ˆë‹¤.

ë‹¤ë§Œ ì—°ê²° ê°¯ìˆ˜ì— ë”°ë¼ ë©”ëª¨ë¦¬ë¥¼ ê³¼í•˜ê²Œ ì°¨ì§€í•˜ê±°ë‚˜, ì‚¬ìš©ìì˜ ëŒ€ê¸°ì‹œê°„ì´ ì¦ê°€í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ì ì¶”ì´ë¥¼ ì˜ íŒŒì•…í•˜ì—¬ ì—°ê²° ì œí•œ ê°¯ìˆ˜ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

---

### createPool ë©”ì„œë“œ

ê¸°ì¡´ ë°©ì‹ê³¼ ê°™ì´ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ê³  `createPool` ë©”ì„œë“œì˜ ì¸ìë¡œ ì „ë‹¬ë˜ëŠ” ê°ì²´ì— ë°ì´í„°ë² ì´ìŠ¤ì˜ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.

`getConnection` ë©”ì„œë“œë¡œ ì»¤ë„¥ì…˜ì„ ë°›ì•„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```js
import mysql from "mysql";

const pool = mysql.createPool({
  host: "db-instance.czm29ewy6sqk.ap-northeast-2.rds.amazonaws.com", //ì‹¤ì œë¡œ ì—°ê²°í•  ë°ì´í„°ë² ì´ìŠ¤ì˜ ìœ„ì¹˜
  user: "psmin",
  password: "java1994",
  database: "user", //ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
  port: 3306,
  connectionLimit: 30,
});

pool.getConnection(function (err, conn) {
  if (err) console.log(err);

  conn.query("SELECT * FROM users", (err, results) => {
    if (err) console.log(err);
    console.log(results);
  });

  conn.release();
});
```

---

## mysql2 ëª¨ë“ˆ

Node.jsì—ì„œ Mysqlì„ ì—°ê²°í•  ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ mysql, mysql2 ê°€ ìˆìŠµë‹ˆë‹¤.

mysql ëª¨ë“ˆì€ ì½œë°± í•¨ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ promiseë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ, promiseë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ mysql2 ëª¨ë“ˆì„ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.

- async / await ì‚¬ìš© ì‹œ ì¥ì 
  - ê°„ê²°í•˜ê³  ê¹”ë”í•œ ì½”ë“œ (ì½œë°± ì§€ì˜¥ X)
  - ê°„í¸í•˜ê²Œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬
  - ê°„í¸í•˜ê²Œ ì—ëŸ¬ ì²˜ë¦¬
  - SQLë¬¸ ìˆœì°¨ì  ì²˜ë¦¬ ë³´ì¥

---

### createConnection ë©”ì„œë“œ (+ Promise)

```js
import mysql from "mysql2/promise";

const password = process.env.DB_PASSWORD;

let conn = await mysql.createConnection({
  host: "localhost", // AWS RDSì˜ ì—”ë“œí¬ì¸íŠ¸
  user: "psmin", // AWS RDSì˜ ë§ˆìŠ¤í„° ì´ë¦„
  password: password, // AWS RDSì˜ ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸
  database: "user", // ì‚¬ìš©í•  ìŠ¤í‚¤ë§ˆ(ë°ì´í„°ë² ì´ìŠ¤) ì´ë¦„
  port: 3306,
});

const [rows] = await conn.query("SELECT * FROM users");

console.log(rows);

conn.end();
```

---

### createPool ë©”ì„œë“œ (+ Promise)

ê°„ë‹¨ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ì™€ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ì‘ì„±ì‹œ catchë¬¸ìœ¼ë¡œ ì—ëŸ¬ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ë©° íŠ¸ëœì­ì…˜ ë¡œì§ì„ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
import mysql from "mysql2/promise";

const pool = await mysql.createPool({
  host: "db-instance.czm29ewy6sqk.ap-northeast-2.rds.amazonaws.com", //ì‹¤ì œë¡œ ì—°ê²°í•  ë°ì´í„°ë² ì´ìŠ¤ì˜ ìœ„ì¹˜
  user: "psmin",
  password: "java1994",
  database: "user", //ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
  port: 3306,
  connectionLimit: 30,
});

const conn = await pool.getConnection(async (conn) => conn);

try {
  await conn.beginTransaction();
  const [rows] = await conn.query("SELECT * FROM users");
  await conn.commit();
  console.log(rows);
} catch (err) {
  await conn.rollback();
  console.log(err);
} finally {
  conn.release();
}
```

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„  ë¹„ë™ê¸°ì‹ ë°©ë²•ì„ í™œìš©í•´ REST APIë¥¼ êµ¬í˜„í•´ë³´ê² ìŠµë‹ˆë‹¤.ğŸ˜Š

---

## ì°¸ì¡°

- <https://veiz.me/37>
- <https://github.com/sidorares/node-mysql2>
