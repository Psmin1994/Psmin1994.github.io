---
title: mysql 모듈들
author: Psmin
data: 2022-01-01 20:35:21 +0900
categories: [Nodejs]
tags: [mysql, mysql2]
---

# mysql 관련 모듈들에 대해 알아보자.

---

## 테이블 생성

로그인, 로그아웃, 회원가입 기능을 구현하기 위해 users 테이블을 생성합니다.

![users-table](/assets/img/users-table.png){: .w-80 .normal}

---

## mysql 모듈

mysql 모듈은 node.js가 mysql의 클라이언트로 작동해 mysql 서버에 접속해서 쿼리 작업을 수행할 수 있게 해주는 모듈입니다.

- 설치
  ```js
  npm i mysql
  ```

---

### createConnection 메서드

모듈을 불러오고 createConnection 메서드의 인자로 전달되는 객체에 데이터베이스의 정보를 입력합니다.

데이터베이스 연결은 config 폴더에 따로 작성한 뒤 필요할 때 import해서 사용할 수 있게 하겠습니다.

```js
import mysql from "mysql";

const password = process.env.DB_PASSWORD;

let conn = mysql.createConnection({
  host: "localhost", // AWS RDS의 엔드포인트
  user: "psmin", // AWS RDS의 마스터 이름
  password: password, // AWS RDS의 마스터 비밀번호
  database: "user", // 사용할 스키마(데이터베이스) 이름
  port: 3306,
});

conn.connect();

export default conn;
```

---

### route 작성

간단한 express 서버를 작성해보겠습니다.

위에서 작성한 연결 코드를 import해 query() 메서드를 사용해 데이터베이스에 원하는 작업을 할 수 있습니다.

query 메서드는 query([SQL문], [SQL문 실행한 결과를 받는 콜백 함수]) 형태로 사용합니다.

```js
import express from "express";
import mysql from "mysql";
import db from "./config/db.js";

const app = express();

app.set("port", process.env.PORT || 3000);

app.get("/", (req, res) => {
  res.send("Root");
});

app.get("/users", (req, res) => {
  // /users로 get 요청이 들어오면
  db.connection.query("SELECT * from users", (err, results) => {
    // query 메서드로 데이터베이스에 SQL문을 요청하고 그 결과가 results 인자로 들어옵니다.
    // SQL문 실행 할 때 에러가 발생하면 err 인자로 들어옵니다.
    if (err) throw error;
    console.log("User info is: ", results);
    res.send(results);
  });
});

app.listen(app.get("port"), () => {
  console.log("Express server listening on port " + app.get("port"));
});
```

---

### 커넥션 풀 (Connection Pool)

Query를 보낼 때마다 Connection을 하는 방식인 createConnection 메서드는 여러 클라이언트에서 동시 요청이 많아져 수용범위를 벗어나면 에러가 발생하는 문제가 발생했습니다.

**_쿼리문을 보낼 때마다 Connection을 생성하는 것_**이 비효율적이기 때문에 등장한 방식이 Connection Pool방식입니다.

- <kbd>기존 방식</kbd>
  ![db-connection-01](/assets/img/db-connection-01.png){: .w-80 .normal}

- <kbd>Connection Pool 방식</kbd>
  ![db-connection-02](/assets/img/db-connection-02.png){: .w-80 .normal}

Connection Pool은 하나의 Pool을 생성한 뒤 지정한 수 만큼 Connection을 미리 할당합니다.

Client에서 DB에 데이터를 가져오기위한 Connection을 Pool에서 가져와 사용한 뒤
다시 Pool에 Connection을 반환합니다.

이러한 방식은 동시 요청 수가 많아져도 에러를 발생시키지 않고 Pool에 남아있는 Connection이 없다면 대기상태가 되고 다른 클라이언트에서 `Connection`이 반환되면 대기상태가 풀리게 됩니다.

---

### createPool 메서드

기존 방식과 같이 모듈을 불러오고 `createPool` 메서드의 인자로 전달되는 객체에 데이터베이스의 정보를 입력합니다.

`getConnection` 메서드로 커넥션을 받아 사용합니다.

위와 같이 config 폴더에 따로 작성한 뒤 필요할 때 import해서 사용할 수 있게 하겠습니다.

```js
import mysql from "mysql";

const password = process.env.DB_PASSWORD;

let pool = mysql.createConnection({
  host: "localhost", // AWS RDS의 엔드포인트
  user: "psmin", // AWS RDS의 마스터 이름
  password: password, // AWS RDS의 마스터 비밀번호
  database: "user", // 사용할 스키마(데이터베이스) 이름
  connectionLimit: 5, // 최대 커넥션 갯수
  port: 3306,
});

const conn = {
  getConnection: (callback) => {
    pool.getConnection((err, conn) => {
      if (err) throw err; //연결 오류 발생시 에러를 던지기
      callback(conn); //콜백 함수에 Connection 객체를 담아 호출
    });
  },
};

export default conn;
```

---

### route 작성

`getConnection` 메서드로 Connection 객체를 받아 쿼리문을 수행한 후 `release` 메서드로 반환합니다.

```js
import express from "express";
import conn from "./config/db.js";

const app = express();

app.set("port", process.env.PORT || 3000);

app.get("/", (req, res) => {
  res.send("Root");
});

app.get("/users", (req, res) => {
  // /users로 get 요청이 들어오면
  const sql = "SELECT * from users";

  conn.getConnection((db) => {
    db.querysql, (err, results) => {
      // query 메서드로 데이터베이스에 SQL문을 요청하고 그 결과가 results 인자로 들어옵니다.
      // SQL문 실행 할 때 에러가 발생하면 err 인자로 들어옵니다.
      if (err) throw error;
      console.log("User info is: ", results);
      res.send(results);
    });

    conn.release();
  });
});

app.listen(app.get("port"), () => {
  console.log("Express server listening on port " + app.get("port"));
});
```

---

## mysql2 모듈

mysql 모듈을 콜백 함수 기반으로 promise를 사용하지 못합니다.  
promise를 사용하기 위해서 mysql2 모듈을 사용해보겠습니다.

---

## 참조

- <https://veiz.me/37>
